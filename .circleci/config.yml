version: 2.1
orbs:
  node: circleci/node@5.2.0
jobs:
  # Job 1 : checkoutEtTests
  checkoutEtTests:
    executor: node/default
    steps:
      - run:
          name: Cloner le backend (git clone)
          command: |
            git clone https://github.com/Spolla12/Projet_Localhost_Backend.git backend
      - run:
          name: Installer les dépendances backend
          command: |
            cd backend
            npm ci || npm install
      - run:
          name: Exécuter les tests backend
          command: |
            cd backend
            npm test

  # Job 2 : integrationFrontend
  integrationFrontend:
    executor: node/default
    steps:
      - run:
          name: Cloner le backend (git clone)
          command: |
            git clone https://github.com/Spolla12/Projet_Localhost_Backend.git backend
      - run:
          name: Cloner le frontend (git clone)
          command: |
            git clone https://github.com/Spolla12/Projet_Localhost_Frontend.git frontend

      - run:
          name: Installer deps + build frontend
          command: |
            cd frontend
            npm ci || npm install
            npm run build

      - run:
          name: Créer backend/public et copier le build dedans
          command: |
            mkdir -p backend/public
            # CRA => build/ | Vite => dist/
            if [ -d "frontend/build" ]; then
              cp -R frontend/build/* backend/public/
            elif [ -d "frontend/dist" ]; then
              cp -R frontend/dist/* backend/public/
            else
              echo "Erreur : Aucun dossier build ou dist trouvé."
              echo "Contenu du dossier frontend :"
              ls -la frontend
              exit 1
            fi

      - persist_to_workspace:
          root: .
          paths:
            - backend

  # Job 3 : deploiement
  deploiement:
    executor: node/default
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Vérification finale (backend prêt pour le cloud)
          command: |
            cd backend
            ls -Rl

workflows:
  version: 2
  pipeline_localhost:
    jobs:
      - checkoutEtTests
      - integrationFrontend:
          requires:
            - checkoutEtTests
      - deploiement:
          requires:
            - integrationFrontend
